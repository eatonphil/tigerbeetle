# Install Go:
sudo add-apt-repository ppa:longsleep/golang-backports
sudo apt update
sudo apt install golang-go

# Add two users, namely voprrunner and voprhub. This creates separation between the two different functions of the server.
# The voprrunner will continuously run the VOPR and send any bugs to the VOPR Hub.
# Will require setting passwords for the respective users
sudo adduser voprhub
sudo adduser voprrunner
sudo usermod -aG sudo voprhub
sudo usermod -aG sudo voprrunner

# Become voprhub user
su - voprhub

# Need two tigerbeetle directories here, one for access to the VOPR Hub and the other as access to the VOPR which will be needed to replay seeds that the hub receives.
git clone https://github.com/coilhq/tigerbeetle.git
mkdir hub
cp -r tigerbeetle hub/tigerbeetle

# Zig needs to be installed globally so that any updates can be done in one place instead of needing to manage them on a directory by directory basis.
./tigerbeetle/scripts/install_zig.sh
mv zig /usr/local/lib

# The code assumes a local installation of Zig so each tigerbeetle directory requires a symlink to point to /usr/local/lib/zig.
ln -s /usr/local/lib/zig ./tigerbeetle
ln -s /usr/local/lib/zig ./hub/tigerbeetle

# Create a systemd service unit file.
sudo nano /etc/systemd/system/voprhub.service
#The file should contain the following (including an actual IP address and developer token with access to public repositories).
[Unit]

Description=Continously runs the VOPR Hub.

[Service]

User=voprhub
WorkingDirectory=/home/voprhub/hub/tigerbeetle/src/vopr
Environment="REPOSITORY_URL=https://api.github.com/repos/coilhq/tigerbeetle/issues"
Environment="TIGERBEETLE_DIRECTORY=/home/voprhub/tigerbeetle"
Environment="VOPR_HUB_ADDRESS=<address>"
Environment="ISSUE_DIRECTORY=/home/voprhub"
Environment="DEVELOPER_TOKEN=******"
ExecStart=go run main.go
Restart=on-success

[Install]

WantedBy=multi-user.target

# Start the VOPR Hub service
systemctl start voprhub.service
# Check it is up
systemctl status voprhub.service
# View logs e.g.
journalctl -f -n 100 -u voprhub.service

# Go back to root user
exit

# Become voprrunner user
su - voprrunner

# Need ten tigerbeetle directories here
git clone https://github.com/coilhq/tigerbeetle.git
cp -r tigerbeetle tigerbeetle1 # repeat with incrementing values for the other instances.
# Can remove original folder
rm -r tigerbeetle

# Create a symlink in each directory to point to /usr/local/lib/zig
ln -s /usr/local/lib/zig ./tigerbeetle1 # repeat with incrementing values for the other instances.

# Create a systemd service unit file.
# Naming the file vopr@.service means it acts as a template that can reuse the same file to run different services that each target their own directories.
sudo nano /etc/systemd/system/vopr@.service
[Unit]
Description=Continously runs the VOPR.
PartOf=vopr.target

[Service]

User=voprrunner
WorkingDirectory=/home/voprrunner/tigerbeetle%i
ExecStart=/home/voprrunner/tigerbeetle%i/zig/zig build vopr -- --send="<address>"
Restart=on-success

[Install]

WantedBy=multi-user.target

# Create a target file to manage all instances, called vopr.target.
sudo nano /etc/systemd/system/vopr.target
[Unit]
Description=Runs all VOPR services.
Requires=vopr@1.service vopr@2.service vopr@3.service vopr@4.service vopr@5.service vopr@6.service vopr@7.service vopr@8.service vopr@9.service vopr@10.service

[Install]
WantedBy=multi-user.target

# Start all services
systemctl start vopr.target
# Check it's up
systemctl status vopr.target
# Check individual services started up
systemctl status vopr@1.service
# View logs e.g.
journalctl -f -n 100 -u vopr@1.service
